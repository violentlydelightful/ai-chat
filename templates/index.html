<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="logo">ðŸ¤–</span>
                <h1>AI Chat</h1>
            </div>

            <button class="btn-new-chat" onclick="newChat()">
                <span>+</span> New Chat
            </button>

            <div class="sidebar-footer">
                {% if demo_mode %}
                <div class="mode-badge demo">Demo Mode</div>
                <p class="mode-note">Add OPENAI_API_KEY for full AI</p>
                {% else %}
                <div class="mode-badge live">AI Connected</div>
                {% endif %}
            </div>
        </aside>

        <!-- Main Chat -->
        <main class="chat-main">
            <!-- Messages -->
            <div class="messages-container" id="messages">
                <div class="welcome-message">
                    <div class="welcome-icon">ðŸ¤–</div>
                    <h2>How can I help you today?</h2>
                    <p>Start a conversation by typing a message below.</p>

                    <div class="suggestions">
                        <button class="suggestion" onclick="sendSuggestion(this)">What can you help me with?</button>
                        <button class="suggestion" onclick="sendSuggestion(this)">Tell me something interesting</button>
                        <button class="suggestion" onclick="sendSuggestion(this)">Help me brainstorm ideas</button>
                    </div>
                </div>
            </div>

            <!-- Input -->
            <div class="input-container">
                <form id="chat-form" onsubmit="sendMessage(event)">
                    <div class="input-wrapper">
                        <textarea
                            id="message-input"
                            placeholder="Type your message..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <button type="submit" class="btn-send" id="send-btn">
                            <span class="send-icon">âž¤</span>
                        </button>
                    </div>
                </form>
                <p class="disclaimer">AI can make mistakes. Consider checking important information.</p>
            </div>
        </main>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        let isWaiting = false;

        // Auto-resize textarea
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
        });

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(e);
            }
        }

        function sendSuggestion(btn) {
            messageInput.value = btn.textContent;
            sendMessage(new Event('submit'));
        }

        async function sendMessage(e) {
            e.preventDefault();

            const message = messageInput.value.trim();
            if (!message || isWaiting) return;

            // Clear welcome message if present
            const welcome = messagesContainer.querySelector('.welcome-message');
            if (welcome) welcome.remove();

            // Add user message
            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Show typing indicator
            isWaiting = true;
            sendBtn.disabled = true;
            const typingId = addTypingIndicator();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                // Remove typing indicator
                removeTypingIndicator(typingId);

                // Add AI response
                addMessage(data.response, 'assistant');

            } catch (error) {
                removeTypingIndicator(typingId);
                addMessage('Sorry, something went wrong. Please try again.', 'assistant error');
            }

            isWaiting = false;
            sendBtn.disabled = false;
            messageInput.focus();
        }

        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';

            // Format content with line breaks and basic markdown
            const formattedContent = formatMessage(content);

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${formattedContent}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatMessage(content) {
            // Convert line breaks
            let formatted = content.replace(/\n/g, '<br>');

            // Convert bullet points
            formatted = formatted.replace(/^â€¢ /gm, '<span class="bullet">â€¢</span> ');

            // Convert bold
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Convert code
            formatted = formatted.replace(/`(.*?)`/g, '<code>$1</code>');

            return formatted;
        }

        function addTypingIndicator() {
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message assistant typing';
            div.innerHTML = `
                <div class="message-avatar">ðŸ¤–</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return id;
        }

        function removeTypingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function newChat() {
            // Clear messages
            messagesContainer.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-icon">ðŸ¤–</div>
                    <h2>How can I help you today?</h2>
                    <p>Start a conversation by typing a message below.</p>

                    <div class="suggestions">
                        <button class="suggestion" onclick="sendSuggestion(this)">What can you help me with?</button>
                        <button class="suggestion" onclick="sendSuggestion(this)">Tell me something interesting</button>
                        <button class="suggestion" onclick="sendSuggestion(this)">Help me brainstorm ideas</button>
                    </div>
                </div>
            `;

            // Clear server-side conversation
            fetch('/api/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
        }

        // Focus input on load
        messageInput.focus();
    </script>
</body>
</html>
