<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 8V4H8"/>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                        <rect x="4" y="8" width="16" height="12" rx="2"/>
                        <path d="M9 13h.01"/>
                        <path d="M15 13h.01"/>
                        <path d="M9 17h6"/>
                    </svg>
                </div>
                <h1>AI Chat</h1>
            </div>

            <button class="btn-new-chat" onclick="newChat()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                New Chat
            </button>

            <div class="sidebar-footer">
                {% if demo_mode %}
                <div class="mode-badge demo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    Demo Mode
                </div>
                <p class="mode-note">Add OPENAI_API_KEY for full AI</p>
                {% else %}
                <div class="mode-badge live">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                    </svg>
                    AI Connected
                </div>
                {% endif %}
            </div>
        </aside>

        <!-- Main Chat -->
        <main class="chat-main">
            <!-- Messages -->
            <div class="messages-container" id="messages">
                <div class="welcome-message">
                    <div class="welcome-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 8V4H8"/>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                            <rect x="4" y="8" width="16" height="12" rx="2"/>
                            <path d="M9 13h.01"/>
                            <path d="M15 13h.01"/>
                            <path d="M9 17h6"/>
                        </svg>
                    </div>
                    <h2>How can I help you today?</h2>
                    <p>Start a conversation by typing a message below.</p>

                    <div class="suggestions">
                        <button class="suggestion" onclick="sendSuggestion(this)">What can you help me with?</button>
                        <button class="suggestion" onclick="sendSuggestion(this)">Tell me something interesting</button>
                        <button class="suggestion" onclick="sendSuggestion(this)">Help me brainstorm ideas</button>
                    </div>
                </div>
            </div>

            <!-- Input -->
            <div class="input-container">
                <form id="chat-form" onsubmit="sendMessage(event)">
                    <div class="input-wrapper">
                        <textarea
                            id="message-input"
                            placeholder="Type your message..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <button type="submit" class="btn-send" id="send-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                </form>
                <p class="disclaimer">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    AI can make mistakes. Consider checking important information.
                </p>
            </div>
        </main>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        let isWaiting = false;

        // SVG icons as strings
        const userIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
        </svg>`;

        const botIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 8V4H8"/>
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
            <rect x="4" y="8" width="16" height="12" rx="2"/>
            <path d="M9 13h.01"/>
            <path d="M15 13h.01"/>
            <path d="M9 17h6"/>
        </svg>`;

        const welcomeHTML = `
            <div class="welcome-message">
                <div class="welcome-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 8V4H8"/>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                        <rect x="4" y="8" width="16" height="12" rx="2"/>
                        <path d="M9 13h.01"/>
                        <path d="M15 13h.01"/>
                        <path d="M9 17h6"/>
                    </svg>
                </div>
                <h2>How can I help you today?</h2>
                <p>Start a conversation by typing a message below.</p>

                <div class="suggestions">
                    <button class="suggestion" onclick="sendSuggestion(this)">What can you help me with?</button>
                    <button class="suggestion" onclick="sendSuggestion(this)">Tell me something interesting</button>
                    <button class="suggestion" onclick="sendSuggestion(this)">Help me brainstorm ideas</button>
                </div>
            </div>
        `;

        // Auto-resize textarea
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
        });

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(e);
            }
        }

        function sendSuggestion(btn) {
            messageInput.value = btn.textContent;
            sendMessage(new Event('submit'));
        }

        async function sendMessage(e) {
            e.preventDefault();

            const message = messageInput.value.trim();
            if (!message || isWaiting) return;

            // Clear welcome message if present
            const welcome = messagesContainer.querySelector('.welcome-message');
            if (welcome) welcome.remove();

            // Add user message
            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Show typing indicator
            isWaiting = true;
            sendBtn.disabled = true;
            const typingId = addTypingIndicator();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                // Remove typing indicator
                removeTypingIndicator(typingId);

                // Add AI response
                addMessage(data.response, 'assistant');

            } catch (error) {
                removeTypingIndicator(typingId);
                addMessage('Sorry, something went wrong. Please try again.', 'assistant error');
            }

            isWaiting = false;
            sendBtn.disabled = false;
            messageInput.focus();
        }

        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = role === 'user' ? userIcon : botIcon;

            // Format content with line breaks and basic markdown
            const formattedContent = formatMessage(content);

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${formattedContent}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatMessage(content) {
            // Convert line breaks
            let formatted = content.replace(/\n/g, '<br>');

            // Convert bullet points
            formatted = formatted.replace(/^• /gm, '<span class="bullet">•</span> ');

            // Convert bold
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Convert code
            formatted = formatted.replace(/`(.*?)`/g, '<code>$1</code>');

            return formatted;
        }

        function addTypingIndicator() {
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message assistant typing';
            div.innerHTML = `
                <div class="message-avatar">${botIcon}</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return id;
        }

        function removeTypingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function newChat() {
            // Clear messages
            messagesContainer.innerHTML = welcomeHTML;

            // Clear server-side conversation
            fetch('/api/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
        }

        // Focus input on load
        messageInput.focus();
    </script>
</body>
</html>
